import{getSearchQueryFromUrl,SEARCH_QUERY,PAGEFIND_PATH,STATS_FILE_PATH,DATA_FILE_PATH_PREFIX}from"/static/global.js";export const QUICK_SEARCH_DELAY=300,DEFAULT_QUICK_SEARCH_COUNT=5,DEFAULT_SEARCH_SELECTORS={searchBar:"#searchbar",searchInput:".search-input",searchBtn:".search-btn",searchDropdown:".search-dropdown",searchResultContainer:".search-results",searchMore:".search-more",searchNonefound:".search-nonefound",searchLoading:".search-loading"};let pagefind,pagefindPromise=null,lastSearchId=0;async function fetchDefaultSnippets(resultCount,skipCount=0){const stats=await(await fetch(STATS_FILE_PATH)).json(),{totalSnippets,snippetsPerFile}=stats;let snippets=[],totalFiles=Math.ceil(totalSnippets/snippetsPerFile),remainderSnippets=totalSnippets%snippetsPerFile;remainderSnippets=remainderSnippets||snippetsPerFile;let deficitSnippets=snippetsPerFile-remainderSnippets,skipFiles=Math.trunc((skipCount+deficitSnippets)/snippetsPerFile),skipIndex=(skipCount+deficitSnippets)%snippetsPerFile;for(let i=totalFiles-skipFiles-1;0<=i&&snippets.length<resultCount;i--){const data=await(await fetch(`${DATA_FILE_PATH_PREFIX}${i}.json`)).json();for(let j=snippetsPerFile-skipIndex-1;0<=j&&snippets.length<resultCount;j--)snippets.push(data.snippets[j]);skipIndex=0}return{snippets,totalSnippets}}export async function fetchSnippets(searchQuery,tags=[],resultCount,skipCount=0){if(!searchQuery&&tags.length==0)return fetchDefaultSnippets(resultCount,skipCount);const pf=await initPagefind();let options=tags.length==0?{}:{filters:{tags:{any:tags}}};const search=await pf.search(searchQuery||null,options),resultRange=search.results.slice(skipCount,skipCount+resultCount);return{snippets:await Promise.all(resultRange.map(async res=>{const data=await res.data();return{url:data?.url??"",title:data?.meta?.title??"",thumbnail:data?.meta?.thumbnail??"",tags:data?.meta?.tags?.split(",").filter(Boolean)??[]}})),totalSnippets:search.results.length}}async function initPagefind(){return pagefindPromise||(pagefindPromise=(async()=>(pagefind=await import(PAGEFIND_PATH),await pagefind.init(),pagefind))()),pagefindPromise}function debounce(func,delay){let timeoutId;return function(...args){timeoutId&&clearTimeout(timeoutId),timeoutId=setTimeout(()=>{func.apply(this,args)},delay)}}function populateSearchDropdown(searchResultContainer,searchMoreElement,searchNonefoundElement,query="",snippets=[],areMoreAvailable=!1){searchResultContainer.querySelectorAll("a").forEach(link=>link.remove()),searchMoreElement.style.display=areMoreAvailable?"":"none",searchMoreElement.href=`/?${SEARCH_QUERY}=${encodeURIComponent(query)}`,searchNonefoundElement.style.display=snippets.length==0&&query.length!=0?"":"none",snippets.forEach(item=>{const anchor=document.createElement("a");anchor.href=item.url,anchor.textContent=item.title,anchor.title=item.title,searchResultContainer.appendChild(anchor)})}async function setupSearchBar(selectors){const searchBar=document.querySelector(selectors.searchBar);if(!searchBar)return;const searchInput=searchBar.querySelector(selectors.searchInput),searchBtn=searchBar.querySelector(selectors.searchBtn),searchResultContainer=searchBar.querySelector(selectors.searchResultContainer),searchMore=searchBar.querySelector(selectors.searchMore),searchNonefound=searchBar.querySelector(selectors.searchNonefound),searchLoading=searchBar.querySelector(selectors.searchLoading),searchQuery=getSearchQueryFromUrl();searchInput.value=searchQuery;const gotoSearchPage=()=>{const query=searchInput.value;window.location.href=query?`/?${SEARCH_QUERY}=${encodeURIComponent(query)}`:window.location.pathname},quickSearch=debounce(async()=>{const thisSearchId=++lastSearchId;populateSearchDropdown(searchResultContainer,searchMore,searchNonefound),searchLoading.style.display="";const query=searchInput.value,quickSearchResults=query===""?[]:(await fetchSnippets(query,[],DEFAULT_QUICK_SEARCH_COUNT+1)).snippets;if(thisSearchId!==lastSearchId)return;searchLoading.style.display="none";let areMoreAvailable=DEFAULT_QUICK_SEARCH_COUNT<quickSearchResults.length;populateSearchDropdown(searchResultContainer,searchMore,searchNonefound,query,quickSearchResults.slice(0,DEFAULT_QUICK_SEARCH_COUNT),areMoreAvailable)},QUICK_SEARCH_DELAY);searchBtn.addEventListener("click",gotoSearchPage),searchInput.addEventListener("keydown",event=>{if(event.key==="Enter"){gotoSearchPage();return}}),searchInput.addEventListener("input",()=>{quickSearch()})}async function setupSearch(selectors=DEFAULT_SEARCH_SELECTORS){initPagefind(),setupSearchBar(selectors)}setupSearch();
